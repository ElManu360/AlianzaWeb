<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Carrito | Alianza Lima</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

<style>
/* Fondo de toda la página */
body {
    margin: 0;
    padding: 0;
    background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
        url("https://tse2.mm.bing.net/th/id/OIP.EKF0x8WMMlkHqpaPwpYs1wHaD_?rs=1&pid=ImgDetMain&o=7&rm=3") no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
}

/* NAVBAR - CORREGIDO A DORADO */
.navbar {
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    background-color: #B8A26A !important; /* Dorado Alianza */
}

.bg-primary {
    background-color: #B8A26A !important;
}

.navbar-brand { font-weight: 700; text-transform: uppercase; }
.nav-link { font-weight: 500; }

/* TABLA DEL CARRITO */
table {
    width: 100%;
    margin-top: 100px;
    background: rgba(0,0,0,0.8); /* Un poco más oscuro para leer mejor */
    color: #fff;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
}

th, td {
    padding: 15px;
    border: 1px solid rgba(184, 162, 106, 0.3); /* Bordes con un toque dorado suave */
    text-align: center;
}

/* Encabezado de la tabla - CORREGIDO A DORADO */
th { 
    background-color: #B8A26A; 
    color: #000; /* Texto oscuro para que resalte sobre el dorado */
    font-weight: bold;
    text-transform: uppercase;
}

/* Inputs de cantidad */
input[type="number"] { 
    width: 65px; 
    text-align: center; 
    border-radius: 5px; 
    border: 1px solid #B8A26A;
    background: #fff;
    color: #000;
}

/* Botones */
.btn-warning { 
    background-color: #B8A26A; 
    border: none; 
    color: white;
    font-weight: bold;
}

.btn-warning:hover { 
    background-color: #9A845C; 
    color: white;
}

.btn-danger { 
    margin-right: 5px;
    border-radius: 5px;
}

.btn-success { 
    margin-top: 20px;
    background-color: #28a745; /* Verde éxito para comprar */
    border: none;
    padding: 10px 30px;
    font-size: 1.1rem;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.btn-success:hover {
    background-color: #218838;
}

/* Importe Final */
#importe-final {
    font-weight: bold;
    color: #B8A26A;
}
.navbar-dark .navbar-nav .nav-link {
    color: #ffffff !important; /* Blanco puro para que resalte */
    font-weight: bold;
}
.bg-primary { 
    background-color: #B8A26A !important; /* Dorado Alianza siempre */
}
</style>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
	    <a class="navbar-brand" th:href="@{/Usuario/menu}">Alianza Lima</a>
	    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
	        <span class="navbar-toggler-icon"></span>
	    </button>
	    <div class="collapse navbar-collapse" id="navbarNav">
	        <ul class="navbar-nav mr-auto">
	            <li class="nav-item">
	                <a class="nav-link" th:href="@{/Usuario/menu}">Inicio</a>
	            </li>
	            <li class="nav-item">
	                <a class="nav-link" th:href="@{/Entradas/disponibles}">Entradas</a>
	            </li>
	            <li class="nav-item">
	                <a class="nav-link" th:href="@{/Producto/Producto}">Productos</a> 
	            </li>
	            <li class="nav-item">
	                <a class="nav-link" th:href="@{/Carrito/Carrito}">Carrito</a> 
	            </li>
	        </ul>
	        <ul class="navbar-nav">
	            <li class="nav-item text-light d-flex align-items-center mr-3">
	                Bienvenido, <strong class="ml-1" th:text="${nombreUsuarioLogeado}">Usuario</strong>
	            </li>
	            <li class="nav-item">
	                <a class="nav-link btn btn-outline-light" th:href="@{/General/logout}">Cerrar Sesión</a> 
	            </li>
	        </ul>
	    </div>
	</nav>

<div class="container mt-5">
    <table id="tabla-carrito">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>IGV (18%)</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h4 class="mt-3">Importe final: S/ <span id="importe-final">0.00</span></h4>
    <button type="button" class="btn btn-success" id="btn-registrar-venta">Registrar Venta</button>
</div>

<script>
// Obtener carrito del localStorage
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
const tbody = document.querySelector('#tabla-carrito tbody');
const spanImporteFinal = document.getElementById('importe-final');
let importeFinal = 0;

// Mostrar carrito
function mostrarCarrito() {
    tbody.innerHTML = '';
    let totalFinal = 0;
    carrito.forEach((producto, index) => {
        const subtotal = producto.precio * producto.cantidad;
        const igv = subtotal * 0.18;
        const total = subtotal + igv;
        totalFinal += total;

        tbody.innerHTML += `
        <tr>
            <td>${producto.nombre}</td>
            <td>S/ ${producto.precio.toFixed(2)}</td>
            <td><input type="number" min="1" value="${producto.cantidad}" onchange="actualizarCantidad(${index}, this.value)"></td>
            <td>S/ ${subtotal.toFixed(2)}</td>
            <td>S/ ${igv.toFixed(2)}</td>
            <td>S/ ${total.toFixed(2)}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">Eliminar</button>
            </td>
        </tr>`;
    });
    importeFinal = totalFinal;
    spanImporteFinal.innerText = importeFinal.toFixed(2);
}

// Actualizar cantidad
function actualizarCantidad(index, cantidad) {
    cantidad = parseInt(cantidad);
    if(cantidad < 1) cantidad = 1;
    carrito[index].cantidad = cantidad;
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
}

// Eliminar producto
function eliminarProducto(index) {
    carrito.splice(index,1);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
}

// Registrar venta
document.getElementById('btn-registrar-venta').addEventListener('click', async (e) => {
    e.preventDefault();

    if (carrito.length === 0) {
        alert("No hay productos para registrar la venta.");
        return;
    }

    // Crear array de ventas sin idVenta
    const ventas = carrito.map(p => {
        const subtotal = p.precio * p.cantidad;
        const igv = subtotal * 0.18;
        const total = subtotal + igv;
        return {
            producto: p.nombre,
            precio: p.precio,
            cantidad: p.cantidad,
            subtotal: subtotal,
            igv: igv,
            total: total
        };
    });

    try {
        const response = await fetch('/ventas/registrar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ventas)
        });

        if(response.ok){
            alert("Venta registrada con éxito!");
            carrito = [];
            localStorage.setItem('carrito', JSON.stringify(carrito));
            mostrarCarrito();
        } else {
            const text = await response.text();
            alert("Error al registrar la venta: " + text);
        }
    } catch (error) {
        console.error(error);
        alert("Error al conectar con el servidor");
    }
});

mostrarCarrito();
</script>
</body>
</html>
